# DLPDF 詳細使用ガイド

このドキュメントでは、`download_and_pdf.sh` スクリプトの詳細な使用方法を説明します。

## コマンド構文

```bash
./download_and_pdf.sh [オプション] <base_url>
```

`base_url` はPDF化対象のウェブページのURLです。デフォルトでは、このURLのみがPDF化されます（単一ページモード）。マルチページモード（`--multi`）を使用すると、このURLをベースとしてサイトマップからURLを取得し、複数のページを処理します。

## オプション一覧

| オプション | 省略形 | 説明 | デフォルト値 |
|-----------|--------|------|------------|
| `--help` | `-h` | ヘルプメッセージを表示して終了 | - |
| `--output DIR` | `-o DIR` | PDFファイルの出力先ディレクトリ | `$HOME/Downloads/<ドメイン名>` |
| `--debug` | `-d` | デバッグモード（一時ファイルを保持） | `false` |
| `--single` | `-s` | 単一ページモード（指定URLのみをPDF化） | `true`（デフォルト） |
| `--multi` | `-m` | 複数ページモード（サイトマップから複数ページを変換） | `false` |
| `--wait NUM` | `-w` | ページ間の待機時間（秒） | `0.1` |

## オプションの詳細

### 出力先ディレクトリ (`--output`, `-o`)

PDFファイルの保存先を指定します。指定したディレクトリが存在しない場合は自動的に作成されます。
指定しない場合、`$HOME/Downloads/<ドメイン名>` が使用されます。

```bash
./download_and_pdf.sh --output ./docs_pdf https://example.com/docs
```

### デバッグモード (`--debug`, `-d`)

一時ファイル（sitemap.xml、urls.txt）を処理後も保持します。問題のトラブルシューティングに役立ちます。

```bash
./download_and_pdf.sh --debug https://example.com
```

### 単一ページモード (`--single`, `-s`)

指定された1つのURLのみをPDFに変換します。これはデフォルトの動作モードです。明示的に指定する必要はありませんが、他のオプションと組み合わせる場合は指定できます。

```bash
./download_and_pdf.sh --single https://example.com/specific-page
```

### 複数ページモード (`--multi`, `-m`)

サイトマップを使用して、指定されたベースURLに関連する複数のページをPDFに変換します。この機能を使用するには、ターゲットウェブサイトがサイトマップを提供している必要があります。

```bash
./download_and_pdf.sh --multi https://example.com
```

### 待機時間 (`--wait`, `-w`)

各ページの処理間の待機時間（秒）を指定します。サーバーに過度な負荷をかけないようにするために使用します。
デフォルトは0.1秒です。主に複数ページモードで使用します。

```bash
./download_and_pdf.sh --multi --wait 3 https://example.com
```

## 複数のオプションの組み合わせ

複数のオプションを組み合わせて使用できます：

```bash
./download_and_pdf.sh --output my_docs --wait 2 --debug --multi https://example.com
```

上記の例では：
- PDFを `my_docs` ディレクトリに保存 (`--output my_docs`)
- ページ処理間に2秒の待機時間を設定 (`--wait 2`)
- デバッグモードを有効にして一時ファイルを保持 (`--debug`)
- サイトマップを使用して複数ページを処理 (`--multi`)

## 動作モード

### 単一ページモード（デフォルト）

デフォルトでは、スクリプトは指定された1つのURLのみをPDF化します：
1. サイトマップの検索・解析をスキップ
2. 指定されたURLを直接PDF化
3. 処理完了後すぐに終了

単一ページモードは以下の場合に特に有用です：
- サイトマップが存在しないウェブサイト
- 特定のページのみをPDF化したい場合
- 処理を迅速に完了させたい場合

### 複数ページモード（`--multi`オプション）

`--multi`オプションを使用すると、サイトマップから関連URLを収集し、一度に複数のページをPDF化します：
1. 指定したベースURLのサブディレクトリでサイトマップを検索
2. サイトマップが見つからない場合、ドメインルートでも検索
3. サイトマップから関連URLを抽出してPDF化

複数ページモードは以下の場合に適しています：
- サイト全体または特定のセクションをバッチでPDF化したい場合
- ウェブサイトが適切にサイトマップを提供している場合

## 対話モード

スクリプトはデフォルトで対話モードで動作します。以下のタイミングで確認が求められます：

1. **出力先ディレクトリの確認**：
   スクリプト開始時に、PDFの保存先ディレクトリを確認または変更できます。

2. **PDF変換失敗時の確認**（複数ページモードのみ）：
   あるURLのPDF変換に失敗した場合、続行するかどうかの確認が表示されます。
   - `y`：処理を続行
   - `n`：処理を中止

## 出力ファイル名

変換されたPDFファイルは、元のURLから生成された名前で保存されます。URLの特殊文字（`/`, `?`, `&`, `=` など）はアンダースコア (`_`) に置き換えられます。

単一ページモードの場合：
- URL: `https://example.com/docs/page.html`
- PDF名: `example.com_docs_page.html.pdf`

複数ページモードの場合：
- URL: `https://example.com/docs/page.html`
- PDF名: `docs_page.html.pdf`（ベースURLが `https://example.com` の場合）

## サイトマップ処理の流れ（複数ページモードのみ）

スクリプトは以下の順序でサイトマップを検索します：
1. 指定されたベースURL配下の `sitemap.xml` を検索
2. 見つからない場合、ドメインのルートにある `sitemap.xml` を検索
3. サイトマップからベースURLに一致するURLのみを抽出して処理

## エラー処理

スクリプトは以下のような場合にエラーメッセージを表示します：
- 必要なツール（curl, grep, sed, awk, Google Chrome）がインストールされていない
- ベースURLが指定されていない
- サイトマップが見つからない、またはダウンロードできない（複数ページモードの場合）
- サイトマップから有効なURLが取得できない（複数ページモードの場合）
- PDF変換に失敗した

## タイムアウト処理

PDF変換処理には60秒のタイムアウトが設定されています。この時間内に変換が完了しない場合、そのURLは失敗としてカウントされます。

## 終了ステータス

スクリプト実行完了後、以下の情報が表示されます：
- 単一ページモードの場合：成功または失敗のメッセージ
- 複数ページモードの場合：
  - 処理したURLの合計数と全体数
  - 成功したPDF変換の数
  - 失敗したPDF変換の数
  - 合計処理時間（秒）
- PDFの出力先ディレクトリ
