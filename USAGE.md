# DLPDF 詳細使用ガイド

このドキュメントでは、`download_and_pdf.sh` スクリプトの詳細な使用方法を説明します。

## コマンド構文

```bash
./download_and_pdf.sh [オプション] <base_url>
```

`base_url` は処理を開始するウェブサイトのURLです。ここで指定されたURLのサイトマップからURLリストが取得されます。

## オプション一覧

| オプション | 省略形 | 説明 | デフォルト値 |
|-----------|--------|------|------------|
| `--help` | `-h` | ヘルプメッセージを表示して終了 | - |
| `--output DIR` | `-o DIR` | PDFファイルの出力先ディレクトリ | `$HOME/Downloads/<ドメイン名>` |
| `--debug` | `-d` | デバッグモード（一時ファイルを保持） | `false` |
| `--wait NUM` | `-w` | ページ間の待機時間（秒） | `0.1` |

## オプションの詳細

### 出力先ディレクトリ (`--output`, `-o`)

PDFファイルの保存先を指定します。指定したディレクトリが存在しない場合は自動的に作成されます。
指定しない場合、`$HOME/Downloads/<ドメイン名>` が使用されます。

```bash
./download_and_pdf.sh --output ./docs_pdf https://example.com/docs
```

### デバッグモード (`--debug`, `-d`)

一時ファイル（sitemap.xml、urls.txt）を処理後も保持します。問題のトラブルシューティングに役立ちます。

```bash
./download_and_pdf.sh --debug https://example.com
```

### 待機時間 (`--wait`, `-w`)

各ページの処理間の待機時間（秒）を指定します。サーバーに過度な負荷をかけないようにするために使用します。
デフォルトは0.1秒です。

```bash
./download_and_pdf.sh --wait 3 https://example.com
```

## 複数のオプションの組み合わせ

複数のオプションを組み合わせて使用できます：

```bash
./download_and_pdf.sh --output my_docs --wait 2 --debug https://example.com
```

上記の例では：
- PDFを `my_docs` ディレクトリに保存 (`--output my_docs`)
- ページ処理間に2秒の待機時間を設定 (`--wait 2`)
- デバッグモードを有効にして一時ファイルを保持 (`--debug`)

## 対話モード

スクリプトはデフォルトで対話モードで動作します。以下のタイミングで確認が求められます：

1. **出力先ディレクトリの確認**：
   スクリプト開始時に、PDFの保存先ディレクトリを確認または変更できます。

2. **PDF変換失敗時の確認**：
   あるURLのPDF変換に失敗した場合、続行するかどうかの確認が表示されます。
   - `y`：処理を続行
   - `n`：処理を中止

## 出力ファイル名

変換されたPDFファイルは、元のURLから生成された名前で保存されます。URLの特殊文字（`/`, `?`, `&`, `=` など）はアンダースコア (`_`) に置き換えられます。

例：
- URL: `https://example.com/docs/page.html`
- PDF名: `docs_page.html.pdf`

## サイトマップ処理の流れ

スクリプトは以下の順序でサイトマップを検索します：
1. 指定されたベースURL配下の `sitemap.xml` を検索
2. 見つからない場合、ドメインのルートにある `sitemap.xml` を検索
3. サイトマップからベースURLに一致するURLのみを抽出して処理

## エラー処理

スクリプトは以下のような場合にエラーメッセージを表示します：
- 必要なツール（curl, grep, sed, awk, Google Chrome）がインストールされていない
- ベースURLが指定されていない
- サイトマップが見つからない、またはダウンロードできない
- サイトマップから有効なURLが取得できない
- PDF変換に失敗した

## タイムアウト処理

PDF変換処理には60秒のタイムアウトが設定されています。この時間内に変換が完了しない場合、そのURLは失敗としてカウントされます。

## 終了ステータス

スクリプト実行完了後、以下の情報が表示されます：
- 処理したURLの合計数と全体数
- 成功したPDF変換の数
- 失敗したPDF変換の数
- 合計処理時間（秒）
- PDFの出力先ディレクトリ
